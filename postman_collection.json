{
  "info": {
    "name": "mabl-order-api",
    "description": "mablの自動テストデモ用REST APIサーバー",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3000",
      "type": "string"
    },
    {
      "key": "token",
      "value": "",
      "type": "string"
    },
    {
      "key": "orderId",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "認証",
      "item": [
        {
          "name": "正しい認証情報でトークンを返す",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ステータスコードが200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('codeが200', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(200);",
                  "});",
                  "",
                  "pm.test('tokenが返される', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('token');",
                  "    pm.collectionVariables.set('token', jsonData.token);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"demo\",\n  \"password\": \"password\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/login",
              "host": ["{{baseUrl}}"],
              "path": ["login"]
            }
          }
        },
        {
          "name": "間違った認証情報で401を返す",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ステータスコードが401', function () {",
                  "    pm.response.to.have.status(401);",
                  "});",
                  "",
                  "pm.test('codeが401', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(401);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"demo\",\n  \"password\": \"wrong\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/login",
              "host": ["{{baseUrl}}"],
              "path": ["login"]
            }
          }
        }
      ]
    },
    {
      "name": "ユーティリティ",
      "item": [
        {
          "name": "認証なしでデータをリセットできる",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ステータスコードが200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('codeが200', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(200);",
                  "});",
                  "",
                  "pm.test('メッセージがDatabase reset', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.message).to.eql('Database reset');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/reset",
              "host": ["{{baseUrl}}"],
              "path": ["api", "reset"]
            }
          }
        },
        {
          "name": "認証なしで初期データを作成できる",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ステータスコードが200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('codeが200', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(200);",
                  "});",
                  "",
                  "pm.test('orderが返される', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('order');",
                  "});",
                  "",
                  "pm.test('order.idが1', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.order.id).to.eql('1');",
                  "});",
                  "",
                  "pm.test('order.statusがcreated', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.order.status).to.eql('created');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/seed",
              "host": ["{{baseUrl}}"],
              "path": ["api", "seed"]
            }
          }
        }
      ]
    },
    {
      "name": "注文作成",
      "item": [
        {
          "name": "認証なしで401を返す",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ステータスコードが401', function () {",
                  "    pm.response.to.have.status(401);",
                  "});",
                  "",
                  "pm.test('codeが401', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(401);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"item\": \"テスト商品\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/orders",
              "host": ["{{baseUrl}}"],
              "path": ["api", "orders"]
            }
          }
        },
        {
          "name": "新規注文を作成できる",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ステータスコードが200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('codeが200', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(200);",
                  "});",
                  "",
                  "pm.test('orderが返される', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('order');",
                  "});",
                  "",
                  "pm.test('order.idが存在する', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.order).to.have.property('id');",
                  "    pm.collectionVariables.set('orderId', jsonData.order.id);",
                  "});",
                  "",
                  "pm.test('order.itemがテスト商品', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.order.item).to.eql('テスト商品');",
                  "});",
                  "",
                  "pm.test('order.statusがcreated', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.order.status).to.eql('created');",
                  "});",
                  "",
                  "pm.test('order.createdAtが存在する', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.order).to.have.property('createdAt');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"item\": \"テスト商品\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/orders",
              "host": ["{{baseUrl}}"],
              "path": ["api", "orders"]
            }
          }
        }
      ]
    },
    {
      "name": "注文取得",
      "item": [
        {
          "name": "存在する注文を取得できる",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ステータスコードが200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('codeが200', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(200);",
                  "});",
                  "",
                  "pm.test('orderが返される', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('order');",
                  "});",
                  "",
                  "pm.test('order.idが一致する', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.order.id).to.eql(pm.collectionVariables.get('orderId'));",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/orders/{{orderId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "orders", "{{orderId}}"]
            }
          }
        },
        {
          "name": "存在しない注文で404を返す",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ステータスコードが404', function () {",
                  "    pm.response.to.have.status(404);",
                  "});",
                  "",
                  "pm.test('codeが404', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(404);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/orders/nonexistent",
              "host": ["{{baseUrl}}"],
              "path": ["api", "orders", "nonexistent"]
            }
          }
        }
      ]
    },
    {
      "name": "支払い処理",
      "item": [
        {
          "name": "created状態の注文を支払い済みにできる",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ステータスコードが200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('codeが200', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(200);",
                  "});",
                  "",
                  "pm.test('orderが返される', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('order');",
                  "});",
                  "",
                  "pm.test('order.statusがpaid', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.order.status).to.eql('paid');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/orders/{{orderId}}/pay",
              "host": ["{{baseUrl}}"],
              "path": ["api", "orders", "{{orderId}}", "pay"]
            }
          }
        },
        {
          "name": "既にpaid状態の注文で400を返す",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ステータスコードが400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('codeが400', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(400);",
                  "});",
                  "",
                  "pm.test('エラーメッセージに「支払いは完了しています」を含む', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.message).to.include('支払いは完了しています');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/orders/{{orderId}}/pay",
              "host": ["{{baseUrl}}"],
              "path": ["api", "orders", "{{orderId}}", "pay"]
            }
          }
        }
      ]
    },
    {
      "name": "発送処理",
      "item": [
        {
          "name": "paid状態の注文を発送済みにできる",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ステータスコードが200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('codeが200', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(200);",
                  "});",
                  "",
                  "pm.test('orderが返される', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('order');",
                  "});",
                  "",
                  "pm.test('order.statusがshipped', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.order.status).to.eql('shipped');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/orders/{{orderId}}/ship",
              "host": ["{{baseUrl}}"],
              "path": ["api", "orders", "{{orderId}}", "ship"]
            }
          }
        },
        {
          "name": "created状態（未払い）の注文で400を返す",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// このテストの前に新しい注文を作成する必要があります",
                  "// Collection Runnerで実行する場合は、先にリセット→ログイン→注文作成を実行してください"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ステータスコードが400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('codeが400', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(400);",
                  "});",
                  "",
                  "pm.test('エラーメッセージに「支払いが完了していないため発送できません」を含む', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.message).to.include('支払いが完了していないため発送できません');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/orders/{{orderId}}/ship",
              "host": ["{{baseUrl}}"],
              "path": ["api", "orders", "{{orderId}}", "ship"]
            }
          }
        }
      ]
    },
    {
      "name": "フロー: 正常系（注文→支払い→発送）",
      "item": [
        {
          "name": "1. データリセット",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('リセット成功', function () {",
                  "    pm.response.to.have.status(200);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/reset",
              "host": ["{{baseUrl}}"],
              "path": ["api", "reset"]
            }
          }
        },
        {
          "name": "2. ログイン",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('ログイン成功', function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('token', jsonData.token);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"demo\",\n  \"password\": \"password\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/login",
              "host": ["{{baseUrl}}"],
              "path": ["login"]
            }
          }
        },
        {
          "name": "3. 注文作成",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('注文作成成功', function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.order.status).to.eql('created');",
                  "    pm.collectionVariables.set('orderId', jsonData.order.id);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"item\": \"Postmanテスト商品\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/orders",
              "host": ["{{baseUrl}}"],
              "path": ["api", "orders"]
            }
          }
        },
        {
          "name": "4. 支払い",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('支払い成功', function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.order.status).to.eql('paid');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/orders/{{orderId}}/pay",
              "host": ["{{baseUrl}}"],
              "path": ["api", "orders", "{{orderId}}", "pay"]
            }
          }
        },
        {
          "name": "5. 発送",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('発送成功', function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.order.status).to.eql('shipped');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/orders/{{orderId}}/ship",
              "host": ["{{baseUrl}}"],
              "path": ["api", "orders", "{{orderId}}", "ship"]
            }
          }
        }
      ]
    }
  ]
}
