openapi: 3.0.0
info:
  title: mabl-order-api
  description: |
    A REST API server for order management, created for demonstrating mabl's API testing capabilities.

    ## State Transitions

    Orders transition through the following states:

    ```
    created --> paid --> shipped
    ```

    | Status | Description |
    |--------|-------------|
    | created | Immediately after order creation (unpaid) |
    | paid | Payment completed |
    | shipped | Shipped |

    ## Authentication

    Endpoints under `/api/orders` require JWT authentication.
    Obtain a token via `POST /login` and authenticate using the `Authorization: Bearer <token>` header.
  version: 1.0.0
  contact:
    name: mabl-order-api

servers:
  - url: http://localhost:3000
    description: Local Development Server

tags:
  - name: Authentication
    description: Authentication endpoints
  - name: Data Management
    description: Demo environment setup (no authentication required)
  - name: Order Management
    description: Create, retrieve, and update order status (authentication required)

paths:
  /login:
    post:
      tags:
        - Authentication
      summary: Login
      description: |
        Authenticate with username and password to obtain a JWT token.

        **Credentials:**
        - Username: `demo`
        - Password: `password`
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: demo
                password:
                  type: string
                  example: password
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: Authentication failed

  /api/reset:
    post:
      tags:
        - Data Management
      summary: Reset Data
      description: |
        Delete all order data from memory and reset.

        **No authentication required** - For demo environment setup
      operationId: resetData
      responses:
        '200':
          description: Reset successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: Database reset

  /api/seed:
    post:
      tags:
        - Data Management
      summary: Create Initial Data
      description: |
        Create demo initial data (ID: 1, status: created).
        Existing data will be reset.

        **No authentication required** - For demo environment setup
      operationId: seedData
      responses:
        '200':
          description: Initial data created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
              example:
                order:
                  id: '1'
                  item: Sample Item
                  status: created
                  createdAt: '2024-01-01T00:00:00.000Z'

  /api/orders:
    post:
      tags:
        - Order Management
      summary: Create Order
      description: |
        Create a new order. Initial status is `created`.
      operationId: createOrder
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - item
              properties:
                item:
                  type: string
                  description: Item name
                  example: Test Item
      responses:
        '200':
          description: Order created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '401':
          description: Authentication error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                noAuth:
                  summary: No authentication header
                  value:
                    message: Authentication required
                invalidToken:
                  summary: Invalid token
                  value:
                    message: Invalid token

  /api/orders/{id}:
    get:
      tags:
        - Order Management
      summary: Get Order
      description: |
        Retrieve order information for the specified ID.
      operationId: getOrder
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Order ID
          schema:
            type: string
      responses:
        '200':
          description: Order retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '401':
          description: Authentication error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: Order not found

  /api/orders/{id}/pay:
    post:
      tags:
        - Order Management
      summary: Process Payment
      description: |
        Update order status to `paid`.

        **Success condition:**
        - Current status must be `created`

        **Error conditions:**
        - Returns 400 error if already `paid` or `shipped`
      operationId: payOrder
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Order ID
          schema:
            type: string
      responses:
        '200':
          description: Payment successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Already paid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: Payment has already been completed
        '401':
          description: Authentication error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: Order not found

  /api/orders/{id}/ship:
    post:
      tags:
        - Order Management
      summary: Process Shipment
      description: |
        Update order status to `shipped`.

        **Success condition:**
        - Current status must be `paid`

        **Error conditions:**
        - Returns 400 error if status is `created` (unpaid)
      operationId: shipOrder
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Order ID
          schema:
            type: string
      responses:
        '200':
          description: Shipment successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Cannot ship - unpaid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: Cannot ship because payment has not been completed
        '401':
          description: Authentication error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: Order not found

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from POST /login

  schemas:
    Order:
      type: object
      description: Order object
      properties:
        id:
          type: string
          description: Order ID
          example: '1'
        item:
          type: string
          description: Item name
          example: Test Item
        status:
          type: string
          description: Order status
          enum:
            - created
            - paid
            - shipped
          example: created
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp (ISO 8601 format)
          example: '2024-01-01T00:00:00.000Z'
      required:
        - id
        - item
        - status
        - createdAt

    OrderResponse:
      type: object
      description: Order response
      properties:
        order:
          $ref: '#/components/schemas/Order'
      required:
        - order

    TokenResponse:
      type: object
      description: Token response
      properties:
        token:
          type: string
          description: JWT token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      required:
        - token

    MessageResponse:
      type: object
      description: Message response
      properties:
        message:
          type: string
          description: Message
          example: Database reset
      required:
        - message

    ErrorResponse:
      type: object
      description: Error response
      properties:
        message:
          type: string
          description: Error message
          example: Authentication required
      required:
        - message
