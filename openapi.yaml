openapi: 3.0.0
info:
  title: mabl-order-api
  description: |
    mablのAPIテスト機能をデモするための注文管理REST APIサーバー。

    ## ステート遷移

    注文は以下のステートを経て遷移します：

    ```
    created --> paid --> shipped
    ```

    | ステータス | 説明 |
    |----------|------|
    | created | 注文作成直後（未払い） |
    | paid | 支払い完了 |
    | shipped | 発送済み |

    ## 認証

    `/api/orders` 以下のエンドポイントはJWT認証が必要です。
    `POST /login` でトークンを取得し、`Authorization: Bearer <token>` ヘッダーで認証してください。
  version: 1.0.0
  contact:
    name: mabl-order-api

servers:
  - url: http://localhost:3000
    description: ローカル開発サーバー

tags:
  - name: 認証
    description: 認証関連のエンドポイント
  - name: データ管理
    description: デモ環境のセットアップ用（認証不要）
  - name: 注文管理
    description: 注文の作成・取得・ステート変更（要認証）

paths:
  /login:
    post:
      tags:
        - 認証
      summary: ログイン
      description: |
        ユーザー名とパスワードで認証し、JWTトークンを取得します。

        **認証情報:**
        - ユーザー名: `demo`
        - パスワード: `password`
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: demo
                password:
                  type: string
                  example: password
      responses:
        '200':
          description: 認証成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: 認証失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: 認証に失敗しました

  /api/reset:
    post:
      tags:
        - データ管理
      summary: データリセット
      description: |
        メモリ上の全注文データを削除してリセットします。

        **認証不要** - デモ環境のセットアップ用
      operationId: resetData
      responses:
        '200':
          description: リセット成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: Database reset

  /api/seed:
    post:
      tags:
        - データ管理
      summary: 初期データ作成
      description: |
        デモ用の初期データ（ID: 1, status: created）を1件作成します。
        既存データはリセットされます。

        **認証不要** - デモ環境のセットアップ用
      operationId: seedData
      responses:
        '200':
          description: 初期データ作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
              example:
                order:
                  id: '1'
                  item: Sample Item
                  status: created
                  createdAt: '2024-01-01T00:00:00.000Z'

  /api/orders:
    post:
      tags:
        - 注文管理
      summary: 注文作成
      description: |
        新規注文を作成します。初期ステータスは `created` です。
      operationId: createOrder
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - item
              properties:
                item:
                  type: string
                  description: 商品名
                  example: テスト商品
      responses:
        '200':
          description: 注文作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                noAuth:
                  summary: 認証ヘッダーなし
                  value:
                    message: 認証が必要です
                invalidToken:
                  summary: 無効なトークン
                  value:
                    message: 無効なトークンです

  /api/orders/{id}:
    get:
      tags:
        - 注文管理
      summary: 注文取得
      description: |
        指定したIDの注文情報を取得します。
      operationId: getOrder
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 注文ID
          schema:
            type: string
      responses:
        '200':
          description: 注文取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 注文が見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: 注文が見つかりません

  /api/orders/{id}/pay:
    post:
      tags:
        - 注文管理
      summary: 支払い処理
      description: |
        注文のステータスを `paid`（支払い済み）に更新します。

        **成功条件:**
        - 現在のステータスが `created` であること

        **エラー条件:**
        - 既に `paid` または `shipped` の場合は 400 エラー
      operationId: payOrder
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 注文ID
          schema:
            type: string
      responses:
        '200':
          description: 支払い成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: 既に支払い済み
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: 支払いは完了しています
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 注文が見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: 注文が見つかりません

  /api/orders/{id}/ship:
    post:
      tags:
        - 注文管理
      summary: 発送処理
      description: |
        注文のステータスを `shipped`（発送済み）に更新します。

        **成功条件:**
        - 現在のステータスが `paid` であること

        **エラー条件:**
        - ステータスが `created`（未払い）の場合は 400 エラー
      operationId: shipOrder
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 注文ID
          schema:
            type: string
      responses:
        '200':
          description: 発送成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: 未払いのため発送不可
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: 支払いが完了していないため発送できません
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 注文が見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: 注文が見つかりません

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: POST /login で取得したJWTトークン

  schemas:
    Order:
      type: object
      description: 注文オブジェクト
      properties:
        id:
          type: string
          description: 注文ID
          example: '1'
        item:
          type: string
          description: 商品名
          example: テスト商品
        status:
          type: string
          description: 注文ステータス
          enum:
            - created
            - paid
            - shipped
          example: created
        createdAt:
          type: string
          format: date-time
          description: 作成日時（ISO 8601形式）
          example: '2024-01-01T00:00:00.000Z'
      required:
        - id
        - item
        - status
        - createdAt

    OrderResponse:
      type: object
      description: 注文レスポンス
      properties:
        order:
          $ref: '#/components/schemas/Order'
      required:
        - order

    TokenResponse:
      type: object
      description: トークンレスポンス
      properties:
        token:
          type: string
          description: JWTトークン
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      required:
        - token

    MessageResponse:
      type: object
      description: メッセージレスポンス
      properties:
        message:
          type: string
          description: メッセージ
          example: Database reset
      required:
        - message

    ErrorResponse:
      type: object
      description: エラーレスポンス
      properties:
        message:
          type: string
          description: エラーメッセージ
          example: 認証が必要です
      required:
        - message
